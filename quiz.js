const questions = [{"text": "Who proposed the planetary model of the atom?", "choices": ["Thomson", "Rutherford", "Bohr", "Dalton"], "answer": 1}, {"text": "What major improvement did Bohr introduce to Rutherford’s model?", "choices": ["Electrons move randomly around the nucleus.", "Electrons occupy specific energy levels.", "Atoms are indivisible.", "The nucleus contains electrons."], "answer": 1}, {"text": "Rutherford’s model could not explain:", "choices": ["The existence of the nucleus", "The charge of electrons", "The stability of atoms", "The discovery of protons"], "answer": 2}, {"text": "In Bohr’s model, what happens when an electron jumps to a higher energy level?", "choices": ["It absorbs energy", "It emits energy", "It becomes neutral", "It splits the atom"], "answer": 0}, {"text": "According to Bohr, energy levels are:", "choices": ["Random and continuous", "Fixed and quantized", "Constant and variable", "Based on neutron count"], "answer": 1}, {"text": "The light emitted by excited hydrogen atoms provides evidence for:", "choices": ["Continuous energy levels", "Quantized energy levels", "Random electron paths", "Proton movement"], "answer": 1}, {"text": "Bohr’s model applies best to:", "choices": ["Multielectron atoms", "Hydrogen atom", "Carbon atom", "Helium atom"], "answer": 1}, {"text": "The nucleus was first discovered by:", "choices": ["Bohr", "Rutherford", "Thomson", "Chadwick"], "answer": 1}, {"text": "In Bohr’s model, the closer an electron is to the nucleus, the:", "choices": ["Higher the energy", "Lower the energy", "Faster the electron", "Greater the radius"], "answer": 1}, {"text": "Bohr’s theory introduced the concept of:", "choices": ["Electron clouds", "Energy quantization", "Neutron discovery", "Isotopes"], "answer": 1}, {"text": "Ionic bonds are formed through:", "choices": ["Sharing of electrons", "Transfer of electrons", "Overlapping of orbitals", "Nuclear fusion"], "answer": 1}, {"text": "Covalent bonds are formed when atoms:", "choices": ["Transfer electrons", "Share electrons", "Lose neutrons", "Gain protons"], "answer": 1}, {"text": "The bond between sodium and chlorine is:", "choices": ["Covalent", "Metallic", "Ionic", "Hydrogen"], "answer": 2}, {"text": "Which pair of elements is most likely to form a covalent bond?", "choices": ["Sodium and chlorine", "Hydrogen and oxygen", "Magnesium and chlorine", "Sodium and fluorine"], "answer": 1}, {"text": "Which property is typical of ionic compounds?", "choices": ["Low melting point", "Poor electrical conductivity when molten", "High melting point", "Soft and flexible"], "answer": 2}, {"text": "Which property is typical of covalent compounds?", "choices": ["High melting point", "Good conductor of electricity", "Usually gaseous or liquid at room temperature", "Formed between metal and nonmetal"], "answer": 2}, {"text": "Ionic compounds form between:", "choices": ["Two nonmetals", "Metal and nonmetal", "Two metals", "Noble gases"], "answer": 1}, {"text": "Covalent bonds form between:", "choices": ["Metals", "Nonmetals", "Metalloids", "Ions"], "answer": 1}, {"text": "When an atom loses an electron, it becomes:", "choices": ["Cation", "Anion", "Isotope", "Radical"], "answer": 0}, {"text": "When an atom gains an electron, it becomes:", "choices": ["Cation", "Anion", "Molecule", "Nucleus"], "answer": 1}, {"text": "Which compound has the highest melting point?", "choices": ["NaCl", "H₂O", "CO₂", "CH₄"], "answer": 0}, {"text": "Which compound conducts electricity when dissolved in water?", "choices": ["CO₂", "NaCl", "H₂O", "CH₄"], "answer": 1}, {"text": "Covalent compounds are generally:", "choices": ["Brittle solids", "Hard and crystalline", "Poor conductors", "Good conductors"], "answer": 2}, {"text": "Ionic compounds dissolve in:", "choices": ["Nonpolar solvents", "Polar solvents", "Oils", "Gasoline"], "answer": 1}, {"text": "A compound that has low melting point and poor conductivity is likely:", "choices": ["Ionic", "Covalent", "Metallic", "Organic"], "answer": 1}, {"text": "NaCl is an example of:", "choices": ["Polar covalent", "Ionic compound", "Nonpolar covalent", "Organic"], "answer": 1}, {"text": "Covalent compounds tend to:", "choices": ["Dissolve in water", "Dissolve in organic solvents", "Conduct electricity", "Be metallic"], "answer": 1}, {"text": "Hardness and brittleness are properties of:", "choices": ["Covalent compounds", "Ionic compounds", "Metallic compounds", "Gaseous molecules"], "answer": 1}, {"text": "Electrical conductivity in metals is due to:", "choices": ["Free electrons", "Shared electrons", "Ions in solution", "Fixed lattice"], "answer": 0}, {"text": "Which compound is polar?", "choices": ["CO₂", "CH₄", "H₂O", "N₂"], "answer": 2}, {"text": "An atom becomes positively charged when it:", "choices": ["Gains protons", "Loses electrons", "Gains electrons", "Loses neutrons"], "answer": 1}, {"text": "An atom becomes negatively charged when it:", "choices": ["Gains electrons", "Loses electrons", "Gains protons", "Gains neutrons"], "answer": 0}, {"text": "What are ions?", "choices": ["Neutral atoms", "Atoms with unequal numbers of protons and electrons", "Radioactive atoms", "Molecules"], "answer": 1}, {"text": "Which atom forms a +2 ion?", "choices": ["Oxygen", "Magnesium", "Fluorine", "Nitrogen"], "answer": 1}, {"text": "Which element tends to form a -1 ion?", "choices": ["Sodium", "Fluorine", "Magnesium", "Aluminum"], "answer": 1}, {"text": "The charge of an ion depends on:", "choices": ["Number of protons lost", "Number of electrons lost or gained", "Number of neutrons gained", "Mass number"], "answer": 1}, {"text": "When Na reacts with Cl, Na becomes:", "choices": ["Na⁺", "Na⁻", "Cl⁺", "Neutral"], "answer": 0}, {"text": "In ionic compounds, metals tend to:", "choices": ["Gain electrons", "Lose electrons", "Share electrons", "Stay neutral"], "answer": 1}, {"text": "Nonmetals tend to:", "choices": ["Lose electrons", "Gain electrons", "Stay neutral", "Form metallic bonds"], "answer": 1}, {"text": "Which best describes anions?", "choices": ["Positively charged", "Negatively charged", "Neutral", "Metallic"], "answer": 1}, {"text": "How many valence electrons does carbon have?", "choices": ["2", "4", "6", "8"], "answer": 1}, {"text": "Carbon can form up to how many covalent bonds?", "choices": ["2", "3", "4", "5"], "answer": 2}, {"text": "Carbon forms stable compounds because:", "choices": ["It can gain 4 electrons", "It can share 4 electrons", "It has a full shell", "It loses 2 electrons"], "answer": 1}, {"text": "The ability of carbon to form chains is called:", "choices": ["Polymerization", "Isomerism", "Catenation", "Bonding"], "answer": 2}, {"text": "The simplest organic compound is:", "choices": ["Methane", "Ethane", "Ethanol", "Butane"], "answer": 0}, {"text": "Carbon atoms can form:", "choices": ["Only single bonds", "Single, double, and triple bonds", "Only double bonds", "Only ionic bonds"], "answer": 1}, {"text": "The property that allows carbon to form many compounds is:", "choices": ["Electronegativity", "Catenation", "Ionization", "Polarization"], "answer": 1}, {"text": "Organic compounds primarily contain:", "choices": ["Carbon and hydrogen", "Carbon and sodium", "Carbon and oxygen only", "Metals"], "answer": 0}, {"text": "Carbon compounds that contain only hydrogen and carbon are called:", "choices": ["Alcohols", "Hydrocarbons", "Esters", "Ketones"], "answer": 1}, {"text": "The carbon atom is versatile due to its:", "choices": ["High mass", "Small size and four valence electrons", "Ionic bonding", "Metallic nature"], "answer": 1}, {"text": "Alcohols contain which functional group?", "choices": ["–COOH", "–OH", "–CHO", "–NH₂"], "answer": 1}, {"text": "Which organic compound is used as fuel?", "choices": ["Methane", "Glucose", "Acetic acid", "Propanol"], "answer": 0}, {"text": "Which compound is a carboxylic acid?", "choices": ["CH₃OH", "CH₃COOH", "CH₄", "C₂H₆"], "answer": 1}, {"text": "Esters are commonly used in:", "choices": ["Fuels", "Perfumes", "Plastics", "Medicines"], "answer": 1}, {"text": "Which compound is an aldehyde?", "choices": ["CH₃CHO", "CH₃OH", "CH₃COOH", "CH₃CH₂NH₂"], "answer": 0}, {"text": "Amines are organic compounds that contain:", "choices": ["Oxygen", "Nitrogen", "Sulfur", "Phosphorus"], "answer": 1}, {"text": "Which compound is used as a solvent?", "choices": ["Ethanol", "Acetic acid", "Methane", "Propane"], "answer": 0}, {"text": "Organic compounds in plastics are usually:", "choices": ["Alkanes", "Polymers", "Esters", "Ketones"], "answer": 1}, {"text": "Glucose is an example of:", "choices": ["Carbohydrate", "Lipid", "Protein", "Hydrocarbon"], "answer": 0}, {"text": "Which class of compounds makes up body fats?", "choices": ["Carbohydrates", "Proteins", "Lipids", "Alcohols"], "answer": 2}];

let currentIndex = 0;
let answers = Array(questions.length).fill(null);
let timerId = null;
let timeLeft = TIME_PER_QUESTION;
let passCount = 0;
let studentName = '';
let studentEmail = '';

const $ = id => document.getElementById(id);
document.addEventListener('DOMContentLoaded', () => {
  const startBtn = $('startBtn');
  const nextBtn = $('nextBtn');
  const restartBtn = $('restartBtn');
  const downloadCsvBtn = $('downloadCsvBtn');
  const confirmSubmitBtn = $('confirmSubmitBtn');
  const cancelSubmitBtn = $('cancelSubmitBtn');

  startBtn.addEventListener('click', startQuiz);
  nextBtn.addEventListener('click', onNext);
  restartBtn.addEventListener('click', restartQuiz);
  downloadCsvBtn.addEventListener('click', downloadCsv);
  confirmSubmitBtn.addEventListener('click', () => { hideConfirmModal(); finalizeAndSubmit(); });
  cancelSubmitBtn.addEventListener('click', () => { hideConfirmModal(); });

  updateProgressUI();
});

function startQuiz(){
  clearToast();
  studentName = $('studentName').value.trim();
  studentEmail = $('studentEmail').value.trim();
  const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
  if(!studentName){ showStartStatus('Please enter your name.'); return; }
  if(!gmailRegex.test(studentEmail)){ showStartStatus('Please enter a valid Gmail (ends with @gmail.com).'); return; }

  $('intro').classList.add('hidden');
  $('quizArea').classList.remove('hidden');
  $('resultArea').classList.add('hidden');

  currentIndex = 0;
  answers = Array(questions.length).fill(null);
  passCount = 0;
  renderQuestion();
  updateProgressUI();
}

function showStartStatus(msg){
  $('startStatus').textContent = msg;
  setTimeout(()=>{ $('startStatus').textContent = ''; }, 3000);
}

function renderQuestion(){
  clearInterval(timerId);
  timeLeft = TIME_PER_QUESTION;
  if(currentIndex < 0 || currentIndex >= questions.length) return handleEndOfPass();
  const q = questions[currentIndex];
  const quizContainer = $('quizContainer');
  quizContainer.innerHTML = '';
  const qDiv = document.createElement('div');
  qDiv.className = 'question';
  qDiv.innerHTML = '<p><strong>Q' + (currentIndex+1) + '.</strong> ' + escapeHtml(q.text) + '</p>';
  const opts = document.createElement('div');
  opts.className = 'options';
  q.choices.forEach((c, idx) => {
    const label = document.createElement('label');
    label.innerHTML = '<input type="radio" name="choice" value="' + idx + '"> ' + escapeHtml(c);
    opts.appendChild(label);
  });
  qDiv.appendChild(opts);
  quizContainer.appendChild(qDiv);

  $('nextBtn').disabled = true;
  const radios = quizContainer.querySelectorAll('input[name="choice"]');
  radios.forEach(r => r.addEventListener('change', () => $('nextBtn').disabled = false));

  const prev = answers[currentIndex];
  if(prev !== null){
    const toCheck = quizContainer.querySelector('input[value="' + prev + '"]');
    if(toCheck){ toCheck.checked = true; $('nextBtn').disabled = false; }
  }

  updateTimerDisplay();
  timerId = setInterval(onTick, 1000);
  updateProgressUI();
}

function onTick(){
  timeLeft--;
  updateTimerDisplay();
  if(timeLeft <= 0){
    clearInterval(timerId);
    showToast('Time ran out — this question will be re-asked after the first pass.');
    advanceIndex();
    renderQuestion();
  }
}

function updateTimerDisplay(){ $('timer').textContent = '⏱️ ' + timeLeft + 's'; }

function onNext(){
  const sel = document.querySelector('input[name="choice"]:checked');
  if(!sel){ showToast('Please select an option before proceeding.'); return; }
  answers[currentIndex] = Number(sel.value);
  advanceIndex();
  renderQuestion();
}

function advanceIndex(){
  currentIndex++;
  if(currentIndex >= questions.length){
    passCount++;
    handleEndOfPass();
  }
}

function handleEndOfPass(){
  const idx = answers.findIndex(a => a === null);
  if(idx === -1){
    showConfirmModal();
  } else {
    currentIndex = idx;
    renderQuestion();
  }
}

function updateProgressUI(){
  const answered = answers.filter(a => a !== null).length;
  const pct = Math.round((answered / questions.length) * 100);
  const fill = $('progressFill');
  fill.style.width = pct + '%';
  fill.textContent = pct + '%';
  $('progress').textContent = 'Answered ' + answered + ' / ' + questions.length;
}

function finishQuiz(){
  clearInterval(timerId);
  $('quizArea').classList.add('hidden');
  $('resultArea').classList.remove('hidden');
  let score = 0;
  let details = '';
  questions.forEach((q,i) => {
    const ua = answers[i];
    const correct = q.answer;
    if(ua === correct) score++;
    const userText = (ua === null) ? '<em>No answer</em>' : escapeHtml(q.choices[ua]);
    const correctText = escapeHtml(q.choices[correct]);
    const status = (ua === correct) ? '✅ Correct' : '❌ Incorrect';
    details += '<div style="margin-bottom:8px;text-align:left"><b>Q' + (i+1) + '.</b> ' + escapeHtml(q.text) + '<br><span class="' + (ua===correct?'correct':'wrong') + '">' + status + '</span><div>Your answer: ' + userText + '</div><div>Correct: ' + correctText + '</div></div>';
  });
  $('resultSummary').innerHTML = '<p><strong>' + escapeHtml(studentName) + '</strong>, your score is <strong>' + score + '/' + questions.length + '</strong>.</p>' + details;
  updateProgressUI();
}

function finalizeAndSubmit(){
  hideConfirmModal();
  finishQuiz();
  try{
    const payload = { name: studentName, email: studentEmail, score: null, total: questions.length, answers, timestamp: new Date().toISOString() };
    fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(()=>{});
  }catch(e){}
}

function restartQuiz(){
  clearInterval(timerId);
  currentIndex = 0;
  answers = Array(questions.length).fill(null);
  passCount = 0;
  studentName = '';
  studentEmail = '';
  $('studentName').value = '';
  $('studentEmail').value = '';
  $('intro').classList.remove('hidden');
  $('quizArea').classList.add('hidden');
  $('resultArea').classList.add('hidden');
  $('progressFill').style.width = '0%';
  $('progressFill').textContent = '0%';
  $('startStatus').textContent = '';
  $('timer').textContent = '';
  updateProgressUI();
}

function downloadCsv(){
  const rows = [
    ['Name','Email','Timestamp','Question','Selected','CorrectAnswer']
  ];
  const ts = new Date().toISOString();
  questions.forEach((q,i) => {
    const sel = answers[i];
    const selText = (sel === null) ? '' : q.choices[sel];
    const corr = q.choices[q.answer];
    rows.push([studentName, studentEmail, ts, q.text, selText, corr]);
  });
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'science-challenge-results-' + (new Date()).toISOString().slice(0,19) + '.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function showConfirmModal(){ const m = $('confirmModal'); m.classList.add('show'); }
function hideConfirmModal(){ const m = $('confirmModal'); m.classList.remove('show'); }

function showToast(msg){ const t = $('toast'); if(!t) return; t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>{ t.classList.add('hidden'); }, 3500); }
function clearToast(){ const t = $('toast'); if(!t) return; t.classList.add('hidden'); t.textContent = ''; }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

setInterval(updateProgressUI, 500);
